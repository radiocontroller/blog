# Mysql与ES数据不一致问题
---

### 1. 问题描述
* 用户在订单支付后，订单处理为已完成，并且同步至ES中，但是ES还是待支付状态。

### 2. 问题原因
* rails项目中引入了Searchkick库，指定了订单在after_commit之后同步至ES，而订单在处理为已完成的过程中，
会先更新为一个中间状态，然后再更新为已完成状态。并且会产生两个update，也就是两个commit，所以导致有两个job进行同步订单信息至ES。
第一个job会更新中间状态至ES，第二个job会更新已完成状态至ES。原因就在于这两个job的执行顺序，第一个job开始执行，但是第一个job在第二个job后结束，
也就是说ES中的订单状态其实先更新成已完成，后面又被第二个job更新为中间状态，也就是覆盖了旧的数据。

### 3. 解决方法
* 将订单处理完成的过程放到一个事务中去，这样只会产生一次commit，也就只有一个同步job会工作。
