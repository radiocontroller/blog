# 缓冲池(buffer pool)以及LRU
---

### 为了减少磁盘IO，加快数据访问，Mysql引入了buffer pool，先看下它的结构
![buffer_pool](https://moto-1252807079.cos.ap-shanghai.myqcloud.com/program/mysql/buffer_pool.png)

### 预读以及它和缓存池的关系
* 磁盘读写，并不是按需读取，而是按页读取，一次至少读一页数据，如果未来要读取的数据就在页中，就能够省去后续的磁盘IO，提高效率
* 磁盘中数据一页一般是4K，而Mysql中一页是16K，即从磁盘中读取4页出来
* 磁盘访问按页读取能够提高性能，所以缓冲池一般也是按页缓存数据
* 预读机制启示了我们，能把一些“可能要访问”的页提前加入缓冲池，避免未来的磁盘IO操作

### 缓冲池的管理
* **Mysql采用的是传统LRU的变种，它解决了两个问题**
  1. **预读失效**：由于预读(Read-Ahead)，提前把页放入了缓冲池，但最终MySQL并没有从页中读取数据，称为预读失效。
      * 解决办法：划分新生代和老生代，预读出来的页数据先放在【老生代头部】，如果后续有访问到该页（例如查找行），再将
        该页移动到【新生代头部】
  2. **缓冲池污染**：当某一个SQL语句，要批量扫描大量数据时，可能把缓冲池的所有页都替换出去，导致大量热数据被换出
      * 解决办法：加入一个【老生代停留时间窗口】的机制，只有满足【被访问】并且【在老生代停留时间】大于T，才会被放入新生代头部

* **什么时候缓冲池中的页，会刷到磁盘上呢？**
  * 定期刷磁盘，而不是每次刷磁盘，能够降低磁盘IO，提升MySQL的性能
      
### 写缓冲（change buffer）
* 它是一种应用在【**非唯一普通索引页**】不在缓冲池中，对页进行了写操作（insert/update/delete），并不会立刻将磁盘页加载到缓冲池，
而仅仅记录缓冲变更，等未来数据被读取时，再将数据合并(merge)恢复到缓冲池中的技术。写缓冲的目的是降低写操作的磁盘IO，提升数据库性能。

* **假如要修改页号为40的索引页，而这个页不在缓冲池内**
![buffer_pool1](https://moto-1252807079.cos.ap-shanghai.myqcloud.com/program/mysql/buffer_pool1.png)

* **加入写缓冲优化后，流程优化为：**
  1. 在写缓冲中记录这个操作，一次内存操作
  2. 写入**redo log**，一次磁盘顺序写操作
  
* **是否会出现一致性问题呢？（答：不会）**
  1. 数据库异常奔溃，能够从redo log中恢复数据
  2. 写缓冲不只是一个内存结构，它也会被定期刷盘到写缓冲系统表空间
  3. 数据读取时，有另外的流程，将数据合并到缓冲池
   
* **假设稍后有请求查询索引页40的数据**
![buffer_pool2](https://moto-1252807079.cos.ap-shanghai.myqcloud.com/program/mysql/buffer_pool2.png)

* **此时的流程：**
  1. 载入索引页，缓冲池未命中，从磁盘中读取页
  2. 从写缓冲读取相关信息
  3. 恢复索引页（磁盘页 + 写缓冲数据），放到缓冲池LRU里
  
* **可以看到，40这一页，在真正被读取时，才会被加载到缓冲池中**

* **最后我们来说一说为什么是应用在【<b>非唯一普通索引页</b>】。如果索引设置了唯一(unique)属性，在进行修改操作时，InnoDB必须进行唯一性检查。
    按照上面的逻辑，只有真正在读取的时候才加载到缓冲池，那么怎么去校验唯一呢？校验唯一就必须进行一次磁盘IO，这与写缓冲为了减少磁盘IO的思想违背了。**

### undo log
* 上面说到了redo log，那么这里再接着说下undo log

* undo log有两个作用：提供回滚和多个行版本控制(MVCC)。

* 在数据修改的时候，不仅记录了redo，还记录了相对应的undo，如果因为某些原因导致事务失败或回滚了，可以借助该undo进行回滚。

* undo log和redo log记录物理日志不一样，它是逻辑日志。**可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然。
当update一条记录时，它记录一条对应相反的update记录。**

* 当应用到行版本控制的时候，也是通过undo log来实现的：当读取的某一行被其他事务锁定时，它可以从undo log中分析出该行记录以前的数据是什么，
从而提供该行版本信息，让用户实现非锁定一致性读取。（例如A进行update，B进行select，那么B应该得到A在update前的数据）

* **另外，undo log也会产生redo log，因为undo log也要实现持久性保护。**

::: tip 相关链接

[https://juejin.cn/post/6844903874172551181](https://juejin.cn/post/6844903874172551181)

[https://juejin.cn/post/6844903875271475213](https://juejin.cn/post/6844903875271475213)

[https://cloud.tencent.com/developer/article/1497335](https://cloud.tencent.com/developer/article/1497335)

[https://zhuanlan.zhihu.com/p/52977862](https://zhuanlan.zhihu.com/p/52977862)
:::